<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vault OS</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                colors: {
                    bg: 'var(--bg)',
                    surface: 'var(--surface)',
                    border: 'var(--border)',
                    text: 'var(--text)',
                    muted: 'var(--muted)',
                    accent: 'var(--accent)',
                },
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                    serif: ['Instrument Serif', 'serif'],
                    mono: ['JetBrains Mono', 'monospace'],
                }
            }
        }
    }
</script>
<style>
    :root {
        --bg: #09090b;
        --surface: #121214;
        --border: #27272a;
        --text: #e4e4e7;
        --muted: #71717a;
        --accent: #3b82f6;
    }
    
    .light-mode {
        --bg: #ffffff;
        --surface: #f4f4f5;
        --border: #e4e4e7;
        --text: #18181b;
        --muted: #a1a1aa;
        --accent: #2563eb;
    }

    body { background-color: var(--bg); color: var(--text); transition: background-color 0.3s, color 0.3s; }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 99px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

    /* Utilities */
    .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(10px); border: 1px solid var(--border); }
    .light-mode .glass { background: rgba(255,255,255,0.8); border-color: var(--border); }
    
    .sidebar-item { @apply flex items-center gap-3 px-3 py-2 rounded-md cursor-pointer text-sm font-medium text-muted transition-all hover:bg-surface hover:text-text; }
    .sidebar-item.active { @apply bg-surface text-accent; }
    
    .note-card { @apply p-4 border-b border-border cursor-pointer hover:bg-surface transition-all; }
    .note-card.active { @apply bg-surface border-l-2 border-l-accent; }

    /* Animations */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-in { animation: fadeIn 0.4s ease-out; }
    
    .loader { border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; width: 20px; height: 20px; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body class="h-screen flex overflow-hidden font-sans text-sm selection:bg-accent selection:text-white">

    <div id="auth-screen" class="fixed inset-0 z-50 bg-bg flex flex-col items-center justify-center">
        <div class="w-full max-w-sm p-8 animate-in text-center">
            <div class="mb-8 font-serif text-5xl italic tracking-tight text-text">Vault.</div>
            <div class="space-y-4">
                <input type="email" id="email" placeholder="Email" class="w-full bg-surface border border-border px-4 py-3 rounded-lg outline-none focus:border-accent transition-colors">
                <input type="password" id="pass" placeholder="Password" class="w-full bg-surface border border-border px-4 py-3 rounded-lg outline-none focus:border-accent transition-colors" onkeydown="if(event.key==='Enter') login()">
                <button id="login-btn" onclick="login()" class="w-full bg-text text-bg font-semibold py-3 rounded-lg hover:opacity-90 transition-opacity">Enter Vault</button>
            </div>
            <div class="mt-12 text-xs text-muted font-mono uppercase tracking-widest">Engineered by Dhruv Shah</div>
            <p id="auth-error" class="mt-4 text-red-500 text-xs h-4"></p>
        </div>
    </div>

    <div id="app" class="hidden w-full h-full flex">
        
        <aside class="w-64 bg-bg border-r border-border flex flex-col">
            <div class="p-5 flex items-center justify-between">
                <span class="font-serif text-2xl italic">Vault.</span>
                <button onclick="toggleTheme()" class="text-muted hover:text-text"><i class="ri-contrast-line text-lg"></i></button>
            </div>

            <div class="px-3 pb-4 border-b border-border space-y-1">
                <div onclick="switchApp('notes')" id="nav-notes" class="sidebar-item active">
                    <i class="ri-booklet-line"></i> <span>Notes</span>
                </div>
                <div onclick="switchApp('drive')" id="nav-drive" class="sidebar-item">
                    <i class="ri-hard-drive-2-line"></i> <span>Drive</span>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto py-4 px-3">
                
                <div id="notes-sidebar" class="space-y-1">
                    <div class="text-xs font-bold text-muted uppercase tracking-wider px-3 mb-2 flex justify-between group">
                        <span>Folders</span>
                        <i onclick="createFolder()" class="ri-add-line cursor-pointer hover:text-text opacity-0 group-hover:opacity-100 transition-opacity"></i>
                    </div>
                    
                    <div id="folder-list" class="space-y-1">
                        </div>

                    <div class="mt-6 text-xs font-bold text-muted uppercase tracking-wider px-3 mb-2">System</div>
                    <div onclick="filterNotes('trash')" class="sidebar-item group">
                        <i class="ri-delete-bin-line group-hover:text-red-400"></i> <span>Trash</span>
                    </div>
                </div>

                <div id="drive-sidebar" class="hidden space-y-4 px-3">
                    <div class="p-4 rounded-xl bg-surface border border-border">
                        <div class="text-xs text-muted mb-1">Storage Used</div>
                        <div class="text-xl font-medium">12%</div>
                        <div class="w-full h-1 bg-border rounded-full mt-3 overflow-hidden">
                            <div class="h-full bg-accent w-[12%]"></div>
                        </div>
                    </div>
                    <button onclick="document.getElementById('upload-input').click()" class="w-full py-2 bg-surface border border-border rounded-lg hover:border-accent hover:text-accent transition-colors text-sm font-medium flex items-center justify-center gap-2">
                        <i class="ri-upload-cloud-line"></i> Upload Files
                    </button>
                    <input type="file" id="upload-input" class="hidden" multiple onchange="uploadFiles(this)">
                </div>
            </div>

            <div class="p-4 border-t border-border">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-accent to-purple-500 flex items-center justify-center text-white font-bold text-xs">D</div>
                    <div class="flex-1 overflow-hidden">
                        <div class="text-xs font-medium truncate" id="user-email">user@vault.com</div>
                    </div>
                </div>
                <div class="flex gap-1">
                    <button onclick="openSettings()" class="flex-1 py-1.5 text-xs bg-surface rounded hover:bg-border transition-colors">Settings</button>
                    <button onclick="logout()" class="flex-1 py-1.5 text-xs bg-surface rounded hover:bg-red-500/10 hover:text-red-500 transition-colors">Logout</button>
                </div>
            </div>
        </aside>

        <main id="app-notes" class="flex-1 flex overflow-hidden">
            
            <div class="w-72 border-r border-border bg-bg flex flex-col">
                <div class="p-4 border-b border-border flex items-center gap-2">
                    <i class="ri-search-line text-muted"></i>
                    <input type="text" placeholder="Search..." class="bg-transparent outline-none w-full text-sm placeholder-muted" oninput="searchNotes(this.value)">
                    <button onclick="createNote()" class="text-accent hover:text-white"><i class="ri-edit-box-line text-xl"></i></button>
                </div>
                <div id="note-list-container" class="flex-1 overflow-y-auto">
                    </div>
            </div>

            <div class="flex-1 flex flex-col bg-surface relative">
                
                <div id="editor-empty" class="absolute inset-0 flex flex-col items-center justify-center text-muted">
                    <i class="ri-quill-pen-line text-6xl opacity-20 mb-4"></i>
                    <p>Select a note to view</p>
                </div>

                <div id="editor-main" class="hidden flex-col h-full">
                    <div class="h-14 border-b border-border flex items-center justify-between px-6 bg-bg">
                        <div class="flex items-center gap-2 text-muted">
                            <span id="note-folder-badge" class="text-xs px-2 py-0.5 rounded bg-surface border border-border">Folder</span>
                            <span id="save-status" class="text-xs">Saved</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="toggleLockNote()" id="btn-lock" title="Password Protect" class="w-8 h-8 rounded hover:bg-surface flex items-center justify-center text-muted transition-colors"><i class="ri-lock-unlock-line"></i></button>
                            <button onclick="togglePinNote()" id="btn-pin" title="Pin Note" class="w-8 h-8 rounded hover:bg-surface flex items-center justify-center text-muted transition-colors"><i class="ri-pushpin-line"></i></button>
                            <button onclick="deleteNote()" title="Move to Trash" class="w-8 h-8 rounded hover:bg-red-500/10 hover:text-red-500 flex items-center justify-center text-muted transition-colors"><i class="ri-delete-bin-line"></i></button>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto">
                        <div class="max-w-3xl mx-auto py-10 px-8">
                            <input id="note-title" type="text" placeholder="Untitled" class="w-full bg-transparent text-4xl font-serif font-bold outline-none placeholder-muted mb-6" oninput="triggerSave()">
                            <textarea id="note-content" placeholder="Start typing... (Tip: Type 'aistart' for AI)" class="w-full h-[70vh] bg-transparent resize-none outline-none font-sans text-base leading-relaxed text-text/90 placeholder-muted/50" oninput="handleInput(this)"></textarea>
                        </div>
                    </div>
                    
                    <div class="h-8 border-t border-border bg-bg flex items-center justify-between px-4 text-xs text-muted font-mono">
                        <div id="word-count">0 words</div>
                        <div>Markdown Supported</div>
                    </div>
                </div>

                <div id="lock-screen" class="hidden absolute inset-0 z-20 bg-surface flex flex-col items-center justify-center">
                    <i class="ri-lock-2-fill text-4xl text-muted mb-4"></i>
                    <h3 class="text-lg font-medium mb-4">This note is password protected</h3>
                    <input type="password" id="unlock-pass" placeholder="Enter Password" class="bg-bg border border-border px-3 py-2 rounded mb-3 w-48 text-center outline-none focus:border-accent">
                    <button onclick="unlockNote()" class="bg-accent text-white px-4 py-2 rounded text-sm">Unlock</button>
                </div>
            </div>
        </main>

        <main id="app-drive" class="hidden flex-1 flex flex-col bg-surface">
            <div class="h-14 border-b border-border bg-bg flex items-center justify-between px-6">
                <div class="flex items-center gap-2 text-sm text-muted">
                    <button onclick="loadDrive('/')" class="hover:text-text"><i class="ri-home-line"></i> Home</button>
                    <span id="breadcrumbs"></span>
                </div>
                <div class="flex gap-2">
                    <button onclick="createDriveFolder()" class="w-8 h-8 rounded hover:bg-surface border border-transparent hover:border-border flex items-center justify-center"><i class="ri-folder-add-line"></i></button>
                    <button onclick="refreshDrive()" class="w-8 h-8 rounded hover:bg-surface border border-transparent hover:border-border flex items-center justify-center"><i class="ri-refresh-line"></i></button>
                </div>
            </div>
            <div id="drive-grid" class="flex-1 p-6 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 content-start overflow-y-auto">
                </div>
        </main>
    </div>

    <div id="settings-modal" class="hidden fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-bg border border-border rounded-xl w-96 p-6 shadow-2xl">
            <h2 class="text-xl font-serif mb-6">Settings</h2>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-muted uppercase">Change Password</label>
                    <input type="password" id="new-pass" placeholder="New Password" class="w-full mt-1 bg-surface border border-border px-3 py-2 rounded outline-none focus:border-accent">
                </div>
                <button onclick="changePassword()" class="w-full bg-accent text-white py-2 rounded">Update Password</button>
            </div>
            <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="mt-4 w-full py-2 text-muted hover:text-text">Close</button>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 bg-surface border border-border text-text px-4 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-3 z-[200]">
        <i class="ri-notification-3-line text-accent"></i>
        <span id="toast-msg">Notification</span>
    </div>

    <script>
        // --- 1. CONFIGURATION (FIXED FOR CONNECTION ISSUES) ---
        const SUPABASE_URL = 'https://psukzzuhpprfoanvjat.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzdWttenp1aHBwcmZvYW52amF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MDU1MDAsImV4cCI6MjA4NjM4MTUwMH0.1fdA4yIYa_8wFUnuFp98YOmS5PQdQMyQ8ylbAKigXs8';
        const UNDETECTABLE_KEY = '135bce90-cb4b-4b54-83e8-5c8d9cf1dd65';

        // --- 2. CRITICAL FIX: DISABLE PERSISTENCE TO PREVENT "FAILED TO FETCH" ---
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: {
                persistSession: false, // Prevents browser blocking
                autoRefreshToken: true,
                detectSessionInUrl: false
            }
        });

        // STATE
        let notes = [], currentNote = null, currentFilter = 'All', drivePath = '/';
        let lockedNotes = JSON.parse(localStorage.getItem('vault_locks') || '{}');

        // --- AUTH ---
        async function login() {
            const btn = document.getElementById('login-btn');
            const err = document.getElementById('auth-error');
            btn.innerText = "Authenticating...";
            err.innerText = "";
            
            const { data, error } = await sb.auth.signInWithPassword({
                email: document.getElementById('email').value,
                password: document.getElementById('pass').value
            });
            
            if (error) {
                err.innerText = error.message;
                btn.innerText = "Enter Vault";
            } else {
                init(data.user);
            }
        }

        async function init(user) {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('user-email').innerText = user.email;
            fetchNotes();
        }

        async function logout() { await sb.auth.signOut(); location.reload(); }

        async function changePassword() {
            const pass = document.getElementById('new-pass').value;
            if(!pass) return toast("Enter a password");
            const { error } = await sb.auth.updateUser({ password: pass });
            if(error) toast(error.message);
            else { toast("Password Updated"); document.getElementById('settings-modal').classList.add('hidden'); }
        }

        // --- NAVIGATION ---
        function switchApp(app) {
            document.getElementById('nav-notes').classList.toggle('active', app === 'notes');
            document.getElementById('nav-drive').classList.toggle('active', app === 'drive');
            document.getElementById('app-notes').classList.toggle('hidden', app !== 'notes');
            document.getElementById('app-drive').classList.toggle('hidden', app !== 'drive');
            document.getElementById('notes-sidebar').classList.toggle('hidden', app !== 'notes');
            document.getElementById('drive-sidebar').classList.toggle('hidden', app !== 'drive');
            if (app === 'drive') loadDrive();
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
        }

        function openSettings() {
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        // --- NOTES SYSTEM ---
        async function fetchNotes() {
            // Robust fetch that handles missing columns gracefully
            const { data, error } = await sb.from('notes').select('*').order('created_at', { ascending: false });
            if(error && error.code === '42703') {
               // If updated_at missing, fetch without sorting by it
               const res = await sb.from('notes').select('*');
               notes = res.data || [];
            } else {
               notes = data || [];
            }
            renderFolders();
            renderNotesList();
        }

        function renderFolders() {
            // Get unique folders from notes
            const folders = [...new Set(notes.map(n => n.folder).filter(f => f && f !== '/' && f !== 'trash'))];
            const container = document.getElementById('folder-list');
            
            let html = `<div onclick="filterNotes('All')" class="sidebar-item ${currentFilter === 'All' ? 'active' : ''}"><i class="ri-inbox-line"></i> All Notes</div>`;
            
            folders.forEach(f => {
                html += `
                <div class="sidebar-item group ${currentFilter === f ? 'active' : ''}" onclick="filterNotes('${f}')">
                    <i class="ri-folder-3-line"></i> <span class="flex-1 truncate">${f}</span>
                </div>`;
            });
            container.innerHTML = html;
        }

        function filterNotes(folder) {
            currentFilter = folder;
            renderFolders();
            renderNotesList();
        }

        function renderNotesList() {
            const container = document.getElementById('note-list-container');
            let filtered = notes;
            
            if (currentFilter === 'trash') {
                filtered = notes.filter(n => n.folder === 'trash');
            } else if (currentFilter !== 'All') {
                filtered = notes.filter(n => n.folder === currentFilter);
            } else {
                filtered = notes.filter(n => n.folder !== 'trash');
            }

            const search = document.querySelector('input[placeholder="Search..."]').value.toLowerCase();
            if (search) filtered = filtered.filter(n => (n.title||'').toLowerCase().includes(search) || (n.content||'').toLowerCase().includes(search));

            container.innerHTML = filtered.map(n => {
                const isLocked = lockedNotes[n.id];
                const preview = isLocked ? '••••••••' : (n.content?.slice(0, 60) || 'No content');
                return `
                <div onclick="openNote('${n.id}')" class="note-card ${currentNote?.id === n.id ? 'active' : ''}">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold text-text truncate ${isLocked ? 'text-accent' : ''}">
                            ${isLocked ? '<i class="ri-lock-fill"></i> ' : ''} ${n.title || 'Untitled'}
                        </span>
                        ${n.is_pinned ? '<i class="ri-pushpin-fill text-accent text-xs"></i>' : ''}
                    </div>
                    <div class="text-xs text-muted line-clamp-2">${preview}</div>
                    <div class="mt-2 text-[10px] text-muted font-mono">${new Date(n.created_at).toLocaleDateString()}</div>
                </div>`;
            }).join('');
        }

        async function createNote() {
            let folder = currentFilter === 'All' || currentFilter === 'trash' ? '/' : currentFilter;
            const { data } = await sb.from('notes').insert([{ title: 'Untitled', content: '', folder }]).select();
            if (data) {
                notes.unshift(data[0]);
                openNote(data[0].id);
                renderNotesList();
            }
        }

        function openNote(id) {
            currentNote = notes.find(n => n.id === id);
            renderNotesList(); 
            
            document.getElementById('editor-empty').classList.add('hidden');
            document.getElementById('editor-main').classList.remove('hidden');
            document.getElementById('editor-main').classList.add('flex');
            
            // Check Lock
            if (lockedNotes[id]) {
                document.getElementById('lock-screen').classList.remove('hidden');
                document.getElementById('unlock-pass').value = '';
                return;
            } else {
                document.getElementById('lock-screen').classList.add('hidden');
            }

            loadEditorData();
        }

        function loadEditorData() {
            document.getElementById('note-title').value = currentNote.title || '';
            document.getElementById('note-content').value = currentNote.content || '';
            document.getElementById('note-folder-badge').innerText = currentNote.folder === '/' ? 'Inbox' : currentNote.folder;
            
            const lockBtn = document.getElementById('btn-lock');
            lockBtn.innerHTML = lockedNotes[currentNote.id] ? '<i class="ri-lock-fill text-accent"></i>' : '<i class="ri-lock-unlock-line"></i>';
            
            updateWordCount();
        }

        // --- EDITOR ACTIONS ---
        let saveTimeout;
        function handleInput(el) {
            updateWordCount();
            
            // Stealth AI Trigger
            const val = el.value;
            if (val.endsWith('aistart')) {
                el.value = val.slice(0, -7); 
                runStealthAI();
                return;
            }
            triggerSave();
        }

        function triggerSave() {
            document.getElementById('save-status').innerText = "Saving...";
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveNote, 1000);
        }

        async function saveNote() {
            if (!currentNote) return;
            const title = document.getElementById('note-title').value;
            const content = document.getElementById('note-content').value;
            
            // Handle schema variations gracefully
            let payload = { title, content };
            // Try to add updated_at, but if it fails, supabase ignores extra fields or we catch it
            try { payload.updated_at = new Date(); } catch(e){}

            await sb.from('notes').update(payload).eq('id', currentNote.id);
            document.getElementById('save-status').innerText = "Saved";
            
            currentNote.title = title;
            currentNote.content = content;
            renderNotesList();
        }

        async function deleteNote() {
            if (currentNote.folder === 'trash') {
                if(!confirm("Permanently delete?")) return;
                await sb.from('notes').delete().eq('id', currentNote.id);
                notes = notes.filter(n => n.id !== currentNote.id);
            } else {
                await sb.from('notes').update({ folder: 'trash' }).eq('id', currentNote.id);
                currentNote.folder = 'trash';
                toast("Moved to Trash");
            }
            currentNote = null;
            document.getElementById('editor-main').classList.add('hidden');
            document.getElementById('editor-empty').classList.remove('hidden');
            fetchNotes();
        }

        function toggleLockNote() {
            if (lockedNotes[currentNote.id]) {
                delete lockedNotes[currentNote.id];
                toast("Note Unlocked");
            } else {
                const pass = prompt("Set password for this note:");
                if (pass) {
                    lockedNotes[currentNote.id] = pass;
                    toast("Note Locked");
                }
            }
            localStorage.setItem('vault_locks', JSON.stringify(lockedNotes));
            openNote(currentNote.id); 
        }

        function unlockNote() {
            const input = document.getElementById('unlock-pass').value;
            if (input === lockedNotes[currentNote.id]) {
                document.getElementById('lock-screen').classList.add('hidden');
                loadEditorData();
            } else {
                toast("Incorrect Password");
            }
        }

        async function createFolder() {
            const name = prompt("Folder Name:");
            if(!name) return;
            const { data } = await sb.from('notes').insert([{ title: 'Welcome to ' + name, content: '', folder: name }]).select();
            if(data) {
                notes.unshift(data[0]);
                renderFolders();
                filterNotes(name);
            }
        }

        // --- DRIVE SYSTEM ---
        async function loadDrive(path = '/') {
            drivePath = path;
            const { data } = await sb.storage.from('files').list(path === '/' ? '' : path);
            const container = document.getElementById('drive-grid');
            
            const crumbs = path === '/' ? '' : path.split('/').map(p => ` / ${p}`).join('');
            document.getElementById('breadcrumbs').innerText = crumbs;

            let html = '';
            if (path !== '/') html += `<div onclick="loadDrive('/')" class="p-4 rounded-xl bg-surface border border-border flex flex-col items-center justify-center cursor-pointer hover:bg-border"><i class="ri-arrow-go-back-line text-xl mb-2 text-muted"></i><span class="text-xs">Back</span></div>`;

            data?.forEach(f => {
                if(f.name === '.keep') return;
                const isFolder = !f.metadata;
                html += `
                <div class="group relative p-4 rounded-xl bg-surface border border-border flex flex-col items-center cursor-pointer hover:border-accent transition-colors" onclick="${isFolder ? `loadDrive('${f.name}')` : `window.open('https://psukzzuhpprfoanvjat.supabase.co/storage/v1/object/public/files/${path === '/' ? '' : path + '/'}${f.name}')`}">
                    <i class="${isFolder ? 'ri-folder-3-fill text-yellow-500' : 'ri-file-text-fill text-blue-400'} text-4xl mb-3"></i>
                    <span class="text-xs text-center w-full truncate">${f.name}</span>
                    <button onclick="event.stopPropagation(); deleteFile('${f.name}')" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 p-1 text-red-500 hover:bg-red-500/10 rounded"><i class="ri-delete-bin-line"></i></button>
                </div>`;
            });
            container.innerHTML = html;
        }

        async function createDriveFolder() {
            const name = prompt("Folder Name:");
            if(!name) return;
            await sb.storage.from('files').upload(`${drivePath === '/' ? '' : drivePath + '/'}${name}/.keep`, new Blob(['']));
            loadDrive(drivePath);
        }

        async function uploadFiles(input) {
            const file = input.files[0];
            if(!file) return;
            toast("Uploading...");
            await sb.storage.from('files').upload(`${drivePath === '/' ? '' : drivePath + '/'}${file.name}`, file);
            loadDrive(drivePath);
            toast("Upload Complete");
        }

        async function deleteFile(name) {
            if(!confirm("Delete?")) return;
            await sb.storage.from('files').remove([`${drivePath === '/' ? '' : drivePath + '/'}${name}`]);
            loadDrive(drivePath);
        }

        // --- STEALTH AI ---
        async function runStealthAI() {
            toast("✨ Optimizing...");
            const text = document.getElementById('note-content').value;
            try {
                const res = await fetch('https://api.undetectable.ai/api/v2/humanize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'api-key': UNDETECTABLE_KEY },
                    body: JSON.stringify({ content: text, readability: 'High School', purpose: 'General Writing' })
                });
                const data = await res.json();
                if(data.output) {
                    document.getElementById('note-content').value = data.output;
                    triggerSave();
                    toast("Refined successfully");
                }
            } catch(e) { toast("AI Error"); }
        }

        // --- UTILS ---
        function updateWordCount() {
            const txt = document.getElementById('note-content').value;
            const count = txt.trim() ? txt.trim().split(/\s+/).length : 0;
            document.getElementById('word-count').innerText = `${count} words`;
        }

        function toast(msg) {
            const el = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            el.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => el.classList.add('translate-y-20', 'opacity-0'), 3000);
        }
        
        function searchNotes(q) {
            renderNotesList();
        }

        // Check Auth
        sb.auth.getSession().then(({ data: { session } }) => { if (session) init(session.user); });
    </script>
</body>
</html>
