<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Verix Vault</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<style>
:root {
  --bg:#0e0f13; --surface:#14161c; --raised:#1c1f28; --border:#272b38;
  --muted:#3a3f52; --text:#dde1ed; --soft:#7c82a0;
  --accent:#c8a97e; --accent2:#7e9fc8; --green:#7ec8a0; --red:#c87e7e;
  --glow:rgba(200,169,126,0.12);
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:'Lato',sans-serif;font-weight:300;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--muted);border-radius:2px;}

/* AUTH */
#auth-screen{position:fixed;inset:0;z-index:100;background:var(--bg);display:flex;align-items:center;justify-content:center;background-image:radial-gradient(ellipse 60% 50% at 50% 0%,rgba(200,169,126,0.07) 0%,transparent 70%);}
.auth-card{width:100%;max-width:400px;padding:3rem 2.5rem;background:var(--surface);border:1px solid var(--border);border-radius:20px;animation:fadeUp 0.5s ease both;}
.auth-logo{width:52px;height:52px;background:linear-gradient(135deg,var(--accent),#a07848);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:22px;margin:0 auto 1.5rem;box-shadow:0 8px 32px rgba(200,169,126,0.3);}
.auth-title{font-family:'DM Serif Display',serif;font-size:2rem;text-align:center;color:var(--text);margin-bottom:0.3rem;}
.auth-sub{text-align:center;color:var(--soft);font-size:0.8rem;margin-bottom:2rem;letter-spacing:0.08em;text-transform:uppercase;}
.auth-input{width:100%;padding:0.8rem 1rem;margin-bottom:0.8rem;background:var(--raised);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:0.9rem;font-family:'Lato',sans-serif;outline:none;transition:border-color 0.2s,box-shadow 0.2s;}
.auth-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--glow);}
.auth-btn{width:100%;padding:0.85rem;background:linear-gradient(135deg,var(--accent),#a07848);border:none;border-radius:10px;color:#0e0f13;font-family:'Lato',sans-serif;font-weight:700;font-size:0.95rem;cursor:pointer;margin-top:0.5rem;transition:opacity 0.2s,transform 0.1s;}
.auth-btn:hover{opacity:0.9;}
.auth-btn:active{transform:scale(0.98);}
#auth-error{color:var(--red);font-size:0.82rem;text-align:center;margin-top:0.8rem;min-height:1.2rem;}

/* LAYOUT */
#app{display:none;width:100%;height:100%;flex-direction:row;}
#app.visible{display:flex;}

/* SIDEBAR */
#sidebar{width:240px;min-width:240px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;height:100%;overflow:hidden;}
.sidebar-top{padding:1.4rem 1.2rem 1rem;border-bottom:1px solid var(--border);}
.brand{font-family:'DM Serif Display',serif;font-size:1.35rem;color:var(--accent);letter-spacing:0.01em;}
.brand-sub{font-size:0.7rem;color:var(--soft);letter-spacing:0.1em;text-transform:uppercase;}
.nav-section{padding:1rem 0.8rem 0;}
.nav-label{font-size:0.65rem;color:var(--muted);letter-spacing:0.12em;text-transform:uppercase;padding:0 0.5rem 0.5rem;}
.nav-item{display:flex;align-items:center;gap:0.7rem;padding:0.65rem 0.75rem;margin-bottom:2px;border-radius:8px;cursor:pointer;font-size:0.87rem;color:var(--soft);transition:all 0.15s;border:1px solid transparent;}
.nav-item:hover{background:var(--raised);color:var(--text);}
.nav-item.active{background:var(--glow);color:var(--accent);border-color:rgba(200,169,126,0.2);}
.nav-item i{font-size:1rem;width:18px;text-align:center;}
.nav-badge{margin-left:auto;background:var(--accent);color:#0e0f13;font-size:0.65rem;font-weight:700;padding:1px 6px;border-radius:10px;}
.sidebar-bottom{margin-top:auto;padding:1rem 0.8rem;border-top:1px solid var(--border);}
.user-pill{display:flex;align-items:center;gap:0.6rem;padding:0.6rem 0.75rem;border-radius:8px;background:var(--raised);margin-bottom:0.5rem;}
.user-avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--accent2),#4a6fa0);display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:700;color:white;flex-shrink:0;}
.user-email{font-size:0.75rem;color:var(--soft);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.logout-btn{display:flex;align-items:center;gap:0.6rem;padding:0.55rem 0.75rem;border-radius:8px;color:var(--soft);font-size:0.82rem;cursor:pointer;transition:all 0.15s;width:100%;background:none;border:none;font-family:'Lato',sans-serif;}
.logout-btn:hover{background:rgba(200,126,126,0.1);color:var(--red);}

/* MAIN */
#main{flex:1;height:100%;overflow:hidden;display:flex;flex-direction:column;}
.topbar{height:52px;min-height:52px;display:flex;align-items:center;justify-content:space-between;padding:0 1.5rem;border-bottom:1px solid var(--border);background:var(--surface);}
.topbar-left{display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;color:var(--soft);}
.topbar-right{display:flex;align-items:center;gap:0.6rem;}
.crumb-btn{color:var(--soft);background:none;border:none;cursor:pointer;font-size:0.82rem;font-family:'Lato',sans-serif;transition:color 0.15s;}
.crumb-btn:hover{color:var(--text);}
.btn-icon{width:32px;height:32px;border-radius:7px;background:var(--raised);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--soft);transition:all 0.15s;font-size:0.9rem;}
.btn-icon:hover{background:var(--border);color:var(--text);}
.btn-primary{display:flex;align-items:center;gap:0.4rem;padding:0.4rem 0.9rem;border-radius:7px;background:var(--accent);color:#0e0f13;border:none;cursor:pointer;font-size:0.82rem;font-weight:700;font-family:'Lato',sans-serif;transition:opacity 0.15s;}
.btn-primary:hover{opacity:0.85;}

/* FILES */
#view-files{flex:1;overflow:hidden;display:flex;flex-direction:column;}
#file-grid{flex:1;padding:1.5rem;overflow-y:auto;display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:0.8rem;align-content:start;}
.file-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1rem 0.8rem;display:flex;flex-direction:column;align-items:center;gap:0.6rem;cursor:pointer;transition:all 0.2s;position:relative;}
.file-card:hover{border-color:var(--muted);background:var(--raised);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.3);}
.file-icon{font-size:2.5rem;line-height:1;}
.file-name{font-size:0.75rem;text-align:center;color:var(--soft);word-break:break-all;line-height:1.3;width:100%;}
.file-actions{position:absolute;top:6px;right:6px;display:none;gap:3px;}
.file-card:hover .file-actions{display:flex;}
.file-action-btn{width:24px;height:24px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:0.7rem;cursor:pointer;border:none;transition:all 0.15s;}
.fa-dl{background:rgba(126,159,200,0.15);color:var(--accent2);}
.fa-dl:hover{background:rgba(126,159,200,0.3);}
.fa-del{background:rgba(200,126,126,0.15);color:var(--red);}
.fa-del:hover{background:rgba(200,126,126,0.3);}
.empty-state{grid-column:1/-1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--muted);padding:4rem;gap:0.8rem;}
.empty-state i{font-size:3rem;opacity:0.3;}
.empty-state p{font-size:0.85rem;}

/* NOTES */
#view-notes{flex:1;overflow:hidden;display:none;}
#view-notes.visible{display:flex;}
.notes-sidebar{width:260px;min-width:260px;border-right:1px solid var(--border);display:flex;flex-direction:column;height:100%;background:var(--surface);}
.notes-header{padding:1rem 1rem 0.8rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.notes-header-title{font-size:0.7rem;color:var(--soft);letter-spacing:0.1em;text-transform:uppercase;}
.search-wrap{position:relative;margin:0.6rem 0.8rem;}
.search-icon{position:absolute;left:0.6rem;top:50%;transform:translateY(-50%);color:var(--muted);font-size:0.8rem;}
#notes-search{width:100%;padding:0.5rem 0.8rem 0.5rem 2rem;background:var(--raised);border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:0.82rem;font-family:'Lato',sans-serif;outline:none;transition:border-color 0.15s;}
#notes-search:focus{border-color:var(--accent);}
#notes-list{flex:1;overflow-y:auto;padding:0.4rem;}
.note-item{padding:0.75rem 0.8rem;border-radius:8px;cursor:pointer;margin-bottom:2px;transition:all 0.15s;border:1px solid transparent;}
.note-item:hover{background:var(--raised);}
.note-item.active{background:var(--glow);border-color:rgba(200,169,126,0.2);}
.note-item-title{font-size:0.85rem;color:var(--text);font-weight:400;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:0.2rem;}
.note-item.active .note-item-title{color:var(--accent);}
.note-item-preview{font-size:0.75rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:0.2rem;}
.note-item-meta{font-size:0.72rem;color:var(--muted);margin-top:0.2rem;}

/* EDITOR */
.editor-area{flex:1;display:flex;flex-direction:column;overflow:hidden;}
#editor-empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--muted);gap:1rem;}
#editor-empty i{font-size:3.5rem;opacity:0.15;}
#editor-empty p{font-size:0.85rem;}
#editor-main{display:none;flex-direction:column;height:100%;}
#editor-main.visible{display:flex;}
.editor-topbar{padding:0.8rem 1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--surface);flex-shrink:0;}
#note-title{background:none;border:none;outline:none;font-family:'DM Serif Display',serif;font-size:1.4rem;color:var(--text);flex:1;margin-right:1rem;}
#note-title::placeholder{color:var(--muted);}
.editor-actions{display:flex;align-items:center;gap:0.5rem;flex-shrink:0;}
#save-status{font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--muted);}
.editor-toolbar{padding:0.4rem 1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:0.3rem;flex-wrap:wrap;background:var(--surface);flex-shrink:0;}
.toolbar-btn{padding:0.3rem 0.6rem;border-radius:5px;border:none;background:none;color:var(--soft);cursor:pointer;font-size:0.82rem;font-family:'Lato',sans-serif;transition:all 0.15s;display:flex;align-items:center;gap:0.3rem;}
.toolbar-btn:hover{background:var(--raised);color:var(--text);}
.toolbar-btn.ai{color:var(--accent);}
.toolbar-btn.ai:hover{background:var(--glow);}
.toolbar-sep{width:1px;height:16px;background:var(--border);margin:0 0.2rem;}
#note-content{flex:1;background:none;border:none;outline:none;resize:none;padding:1.5rem 2rem;font-family:'DM Mono',monospace;font-size:0.88rem;line-height:1.9;color:var(--text);overflow-y:auto;}
#note-content::placeholder{color:var(--muted);}
.editor-footer{padding:0.4rem 1.5rem;border-top:1px solid var(--border);display:flex;align-items:center;gap:1rem;font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--muted);background:var(--surface);flex-shrink:0;}

/* MODAL */
.modal-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:1rem;}
.modal-overlay.hidden{display:none;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:1.5rem;width:100%;max-width:580px;animation:fadeUp 0.25s ease both;}
.modal-title{font-family:'DM Serif Display',serif;font-size:1.2rem;color:var(--text);margin-bottom:1rem;display:flex;justify-content:space-between;align-items:center;}
.modal-close{background:none;border:none;color:var(--soft);cursor:pointer;font-size:1.2rem;}
.modal-close:hover{color:var(--text);}
.modal-textarea{width:100%;padding:0.8rem 1rem;background:var(--raised);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.82rem;line-height:1.7;resize:none;outline:none;margin-bottom:0.8rem;transition:border-color 0.15s;}
.modal-textarea:focus{border-color:var(--accent);}
.modal-actions{display:flex;gap:0.6rem;justify-content:flex-end;}
.btn-ghost{padding:0.5rem 1rem;border-radius:7px;background:var(--raised);border:1px solid var(--border);color:var(--soft);cursor:pointer;font-family:'Lato',sans-serif;font-size:0.85rem;transition:all 0.15s;}
.btn-ghost:hover{color:var(--text);border-color:var(--muted);}
.result-box{background:var(--raised);border:1px solid rgba(126,200,160,0.2);border-radius:8px;padding:0.8rem 1rem;margin-top:0.8rem;font-family:'DM Mono',monospace;font-size:0.82rem;line-height:1.7;color:var(--green);max-height:200px;overflow-y:auto;white-space:pre-wrap;}
.copy-btn{display:flex;align-items:center;gap:0.4rem;margin-top:0.5rem;font-size:0.78rem;color:var(--soft);background:none;border:none;cursor:pointer;font-family:'Lato',sans-serif;transition:color 0.15s;}
.copy-btn:hover{color:var(--green);}

/* LOADER */
#loader{position:fixed;inset:0;z-index:300;background:rgba(14,15,19,0.75);backdrop-filter:blur(6px);display:none;flex-direction:column;align-items:center;justify-content:center;gap:1rem;}
#loader.visible{display:flex;}
.spinner{width:36px;height:36px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.7s linear infinite;}
#loader-text{font-size:0.85rem;color:var(--soft);font-family:'DM Mono',monospace;}

/* TOAST */
#toast{position:fixed;bottom:1.5rem;right:1.5rem;z-index:400;background:var(--raised);border:1px solid var(--border);border-radius:10px;padding:0.7rem 1rem;font-size:0.83rem;color:var(--text);display:flex;align-items:center;gap:0.5rem;transform:translateY(20px);opacity:0;transition:all 0.3s;pointer-events:none;}
#toast.show{transform:translateY(0);opacity:1;}
#toast.success{border-color:rgba(126,200,160,0.3);color:var(--green);}
#toast.error{border-color:rgba(200,126,126,0.3);color:var(--red);}

/* CTX MENU */
.ctx-menu{position:fixed;z-index:500;background:var(--raised);border:1px solid var(--border);border-radius:10px;padding:0.4rem;min-width:150px;box-shadow:0 16px 48px rgba(0,0,0,0.5);animation:fadeUp 0.15s ease both;}
.ctx-menu.hidden{display:none;}
.ctx-item{padding:0.5rem 0.8rem;border-radius:6px;cursor:pointer;font-size:0.82rem;color:var(--soft);display:flex;align-items:center;gap:0.5rem;transition:all 0.1s;}
.ctx-item:hover{background:var(--border);color:var(--text);}
.ctx-item.danger{color:var(--red);}
.ctx-item.danger:hover{background:rgba(200,126,126,0.1);}
.ctx-sep{height:1px;background:var(--border);margin:0.3rem 0;}

@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-logo">üóù</div>
    <h1 class="auth-title">Verix Vault</h1>
    <p class="auth-sub">Private ¬∑ Encrypted ¬∑ Yours</p>
    <input class="auth-input" id="email" type="email" placeholder="Email address">
    <input class="auth-input" id="pass" type="password" placeholder="Password" onkeydown="if(event.key==='Enter')handleLogin()">
    <button class="auth-btn" id="login-btn" onclick="handleLogin()">Unlock Vault</button>
    <p id="auth-error"></p>
  </div>
</div>

<div id="app">
  <nav id="sidebar">
    <div class="sidebar-top">
      <div class="brand">Verix</div>
      <div class="brand-sub">Personal Vault</div>
    </div>
    <div class="nav-section">
      <div class="nav-label">Workspace</div>
      <div class="nav-item active" id="nav-files" onclick="switchView('files')"><i class="ri-hard-drive-3-line"></i> Drive</div>
      <div class="nav-item" id="nav-notes" onclick="switchView('notes')"><i class="ri-quill-pen-line"></i> Notes <span class="nav-badge" id="notes-count">0</span></div>
    </div>
    <div class="nav-section" style="margin-top:0.5rem">
      <div class="nav-label">AI Tools</div>
      <div class="nav-item" onclick="openHumanizer()"><i class="ri-sparkling-2-line"></i> Humanizer</div>
      <div class="nav-item" onclick="openSummarizer()"><i class="ri-file-reduce-line"></i> Summarize</div>
    </div>
    <div class="sidebar-bottom">
      <div class="user-pill">
        <div class="user-avatar" id="user-av">V</div>
        <div class="user-email" id="user-email-display">‚Äî</div>
      </div>
      <button class="logout-btn" onclick="logout()"><i class="ri-logout-box-r-line"></i> Sign Out</button>
    </div>
  </nav>

  <main id="main">
    <div id="view-files" style="flex:1;overflow:hidden;display:flex;flex-direction:column;">
      <div class="topbar">
        <div class="topbar-left">
          <button class="crumb-btn" onclick="openFolder('/')"><i class="ri-home-4-line"></i> Home</button>
          <span id="breadcrumbs"></span>
        </div>
        <div class="topbar-right">
          <div class="btn-icon" onclick="createFolder()" title="New Folder"><i class="ri-folder-add-line"></i></div>
          <label class="btn-primary" style="cursor:pointer;"><i class="ri-upload-2-line"></i> Upload<input type="file" style="display:none" onchange="uploadFile(this)" multiple></label>
        </div>
      </div>
      <div id="file-grid"></div>
    </div>

    <div id="view-notes">
      <div class="notes-sidebar">
        <div class="notes-header">
          <span class="notes-header-title">All Notes</span>
          <div class="btn-icon" onclick="createNewNote()" title="New Note" style="width:26px;height:26px;font-size:0.8rem;"><i class="ri-add-line"></i></div>
        </div>
        <div class="search-wrap">
          <i class="ri-search-line search-icon"></i>
          <input id="notes-search" placeholder="Search notes‚Ä¶" oninput="filterNotes(this.value)">
        </div>
        <div id="notes-list"></div>
      </div>
      <div class="editor-area">
        <div id="editor-empty"><i class="ri-quill-pen-line"></i><p>Select a note or press + to create one</p></div>
        <div id="editor-main">
          <div class="editor-topbar">
            <input id="note-title" placeholder="Untitled Note" oninput="autoSave()">
            <div class="editor-actions">
              <span id="save-status">Saved</span>
              <div class="btn-icon" onclick="togglePin()" id="pin-btn" title="Pin"><i class="ri-pushpin-line"></i></div>
              <div class="btn-icon" onclick="exportNote()" title="Export"><i class="ri-download-line"></i></div>
              <div class="btn-icon" onclick="copyNoteContent()" title="Copy"><i class="ri-file-copy-line"></i></div>
              <div class="btn-icon" onclick="deleteCurrentNote()" title="Delete" style="color:var(--red)"><i class="ri-delete-bin-line"></i></div>
            </div>
          </div>
          <div class="editor-toolbar">
            <button class="toolbar-btn" onclick="insertMd('**','**')" title="Bold"><i class="ri-bold"></i></button>
            <button class="toolbar-btn" onclick="insertMd('*','*')" title="Italic"><i class="ri-italic"></i></button>
            <button class="toolbar-btn" onclick="insertMd('`','`')" title="Code"><i class="ri-code-line"></i></button>
            <button class="toolbar-btn" onclick="insertMd('~~','~~')" title="Strike"><i class="ri-strikethrough"></i></button>
            <button class="toolbar-btn" onclick="insertPrefix('# ')" title="H1"><i class="ri-h-1"></i></button>
            <button class="toolbar-btn" onclick="insertPrefix('## ')" title="H2"><i class="ri-h-2"></i></button>
            <button class="toolbar-btn" onclick="insertPrefix('- ')" title="List"><i class="ri-list-unordered"></i></button>
            <button class="toolbar-btn" onclick="insertPrefix('> ')" title="Quote"><i class="ri-double-quotes-r"></i></button>
            <button class="toolbar-btn" onclick="insertPrefix('- [ ] ')" title="Checklist"><i class="ri-checkbox-line"></i></button>
            <div class="toolbar-sep"></div>
            <button class="toolbar-btn ai" onclick="humanizeNote()"><i class="ri-sparkling-fill"></i> Humanize</button>
            <button class="toolbar-btn ai" onclick="summarizeNote()"><i class="ri-file-reduce-line"></i> Summarize</button>
          </div>
          <textarea id="note-content" placeholder="Start writing‚Ä¶ markdown shortcuts work too" oninput="autoSave();updateCounts()"></textarea>
          <div class="editor-footer">
            <span id="word-count">0 words</span>
            <span id="char-count">0 chars</span>
            <span id="line-count">0 lines</span>
            <span id="last-saved" style="margin-left:auto;"></span>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<div id="loader"><div class="spinner"></div><div id="loader-text">Loading‚Ä¶</div></div>
<div id="toast"></div>

<!-- HUMANIZER MODAL -->
<div class="modal-overlay hidden" id="humanizer-modal">
  <div class="modal">
    <div class="modal-title"><span><i class="ri-sparkling-2-line" style="color:var(--accent)"></i> AI Humanizer</span><button class="modal-close" onclick="closeModal('humanizer-modal')"><i class="ri-close-line"></i></button></div>
    <textarea class="modal-textarea" id="humanizer-input" rows="7" placeholder="Paste AI-generated text here‚Ä¶"></textarea>
    <div class="modal-actions">
      <button class="btn-ghost" onclick="closeModal('humanizer-modal')">Cancel</button>
      <button class="btn-primary" onclick="runHumanizer()"><i class="ri-sparkling-fill"></i> Humanize</button>
    </div>
    <div id="humanizer-result" style="display:none">
      <div class="result-box" id="humanizer-output"></div>
      <div style="display:flex;gap:0.8rem;margin-top:0.5rem;">
        <button class="copy-btn" onclick="copyResult('humanizer-output')"><i class="ri-file-copy-line"></i> Copy</button>
        <button class="copy-btn" onclick="insertHumanizerToNote()" style="color:var(--accent)"><i class="ri-arrow-right-line"></i> Insert into note</button>
      </div>
    </div>
  </div>
</div>

<!-- SUMMARIZER MODAL -->
<div class="modal-overlay hidden" id="summarizer-modal">
  <div class="modal">
    <div class="modal-title"><span><i class="ri-file-reduce-line" style="color:var(--accent2)"></i> AI Summarizer</span><button class="modal-close" onclick="closeModal('summarizer-modal')"><i class="ri-close-line"></i></button></div>
    <textarea class="modal-textarea" id="summarizer-input" rows="7" placeholder="Paste text to summarize‚Ä¶"></textarea>
    <div class="modal-actions">
      <button class="btn-ghost" onclick="closeModal('summarizer-modal')">Cancel</button>
      <button class="btn-primary" style="background:var(--accent2);color:#0e0f13;" onclick="runSummarizer()"><i class="ri-file-reduce-line"></i> Summarize</button>
    </div>
    <div id="summarizer-result" style="display:none">
      <div class="result-box" id="summarizer-output" style="color:var(--accent2);border-color:rgba(126,159,200,0.2)"></div>
      <button class="copy-btn" onclick="copyResult('summarizer-output')"><i class="ri-file-copy-line"></i> Copy</button>
    </div>
  </div>
</div>

<!-- CONTEXT MENU -->
<div class="ctx-menu hidden" id="ctx-menu">
  <div class="ctx-item" id="ctx-open"><i class="ri-edit-line"></i> Open</div>
  <div class="ctx-item" id="ctx-pin"><i class="ri-pushpin-line"></i> Pin</div>
  <div class="ctx-item" id="ctx-export"><i class="ri-download-line"></i> Export</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item danger" id="ctx-delete"><i class="ri-delete-bin-line"></i> Delete</div>
</div>

<script>
const SUPABASE_URL = 'https://psukmzzuhpprfoanvjat.supabase.co';
const SUPABASE_KEY = 'sb_publishable_FLl6k_0aVgH_R7bKNkzsfA_HYTIM304';

let sb;
try {
  sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
    auth: { persistSession: false, autoRefreshToken: true, detectSessionInUrl: false }
  });
} catch(e) { alert('Init error: ' + e.message); }

let currentPath = '/';
let activeNoteId = null;
let saveTimeout = null;
let allNotes = [];
let pinnedNotes = new Set(JSON.parse(localStorage.getItem('vx_pins') || '[]'));

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
function showLoader(v, t='Loading‚Ä¶') {
  document.getElementById('loader').classList.toggle('visible', v);
  document.getElementById('loader-text').textContent = t;
}
function showToast(msg, type='') {
  const el = document.getElementById('toast');
  el.textContent = msg; el.className = 'show ' + type;
  setTimeout(() => el.className = '', 3200);
}
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
async function handleLogin() {
  const btn = document.getElementById('login-btn');
  const err = document.getElementById('auth-error');
  btn.textContent = 'Verifying‚Ä¶'; btn.disabled = true; err.textContent = '';
  const email = document.getElementById('email').value.trim();
  const pass  = document.getElementById('pass').value;
  if (!email || !pass) { err.textContent = 'Enter email and password'; btn.textContent = 'Unlock Vault'; btn.disabled = false; return; }
  try {
    const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
    if (error) {
      err.textContent = error.message.includes('Invalid') ? 'Wrong email or password' : error.message;
      btn.textContent = 'Unlock Vault'; btn.disabled = false;
    } else {
      btn.textContent = '‚úì Unlocked';
      document.getElementById('user-email-display').textContent = data.user.email;
      document.getElementById('user-av').textContent = data.user.email[0].toUpperCase();
      setTimeout(initApp, 350);
    }
  } catch(e) {
    err.textContent = e.message.includes('fetch') ? 'Cannot reach server ‚Äî open via localhost, not file://' : e.message;
    btn.textContent = 'Unlock Vault'; btn.disabled = false;
  }
}
async function logout() { try { await sb.auth.signOut(); } catch(e){} location.reload(); }

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
function initApp() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').classList.add('visible');
  loadFiles(); loadNotes();
}
function switchView(v) {
  document.getElementById('nav-files').classList.toggle('active', v==='files');
  document.getElementById('nav-notes').classList.toggle('active', v==='notes');
  document.getElementById('view-files').style.display = v==='files' ? 'flex' : 'none';
  document.getElementById('view-notes').classList.toggle('visible', v==='notes');
}

// ‚îÄ‚îÄ FILES ‚îÄ‚îÄ
async function loadFiles() {
  showLoader(true, 'Loading Drive‚Ä¶');
  try {
    const path = currentPath === '/' ? '' : currentPath;
    const { data, error } = await sb.storage.from('files').list(path, { limit: 300, sortBy: { column: 'name', order: 'asc' } });
    if (error) { showToast('Storage: ' + error.message, 'error'); showLoader(false); return; }
    renderFiles(data || []);
  } catch(e) { showToast('Drive error: ' + e.message, 'error'); }
  showLoader(false);
}
function renderFiles(data) {
  const grid = document.getElementById('file-grid');
  const items = data.filter(i => i.name !== '.keep');
  let html = '';
  if (currentPath !== '/') html += `<div class="file-card" onclick="goUp()"><span class="file-icon">‚¨ÜÔ∏è</span><span class="file-name" style="color:var(--soft)">Go Back</span></div>`;
  if (!items.length && currentPath === '/') html += `<div class="empty-state"><i class="ri-inbox-2-line"></i><p>Your Drive is empty ‚Äî upload something</p></div>`;
  items.forEach(item => {
    const isFolder = !item.metadata;
    const icon = isFolder ? 'üìÅ' : getEmoji(item.name);
    html += `<div class="file-card" ${isFolder ? `onclick="openFolder('${item.name}')"` : ''}>
      <span class="file-icon">${icon}</span>
      <span class="file-name" title="${item.name}">${item.name}</span>
      <div class="file-actions">
        ${!isFolder ? `<button class="file-action-btn fa-dl" onclick="downloadFile('${item.name}');event.stopPropagation()" title="Download"><i class="ri-download-2-line"></i></button>
        <button class="file-action-btn fa-del" onclick="deleteFile('${item.name}');event.stopPropagation()" title="Delete"><i class="ri-delete-bin-line"></i></button>` : ''}
      </div>
    </div>`;
  });
  grid.innerHTML = html;
}
function getEmoji(n) {
  const e = n.split('.').pop()?.toLowerCase();
  return {pdf:'üìÑ',doc:'üìù',docx:'üìù',xls:'üìä',xlsx:'üìä',ppt:'üìä',pptx:'üìä',jpg:'üñº',jpeg:'üñº',png:'üñº',gif:'üéû',mp4:'üé¨',mp3:'üéµ',zip:'üì¶',txt:'üìÉ',md:'üìÉ',js:'üíª',py:'üíª',html:'üíª',json:'üíª'}[e] || 'üìé';
}
function openFolder(n) { currentPath = n==='/' ? '/' : (currentPath==='/' ? n : `${currentPath}/${n}`); updateBC(); loadFiles(); }
function goUp() { const p = currentPath.split('/').filter(Boolean); p.pop(); currentPath = p.length ? p.join('/') : '/'; updateBC(); loadFiles(); }
function updateBC() {
  const bc = document.getElementById('breadcrumbs');
  bc.innerHTML = currentPath==='/' ? '' : currentPath.split('/').filter(Boolean).map(p=>`<span style="color:var(--muted);margin:0 4px">/</span><span style="color:var(--text)">${p}</span>`).join('');
}
async function createFolder() {
  const n = prompt('Folder name:'); if (!n?.trim()) return;
  const { error } = await sb.storage.from('files').upload(`${currentPath==='/'?'':currentPath+'/'}${n.trim()}/.keep`, new Blob(['']));
  if (error && !error.message.includes('already')) { showToast(error.message, 'error'); return; }
  loadFiles(); showToast('Folder created ‚úì', 'success');
}
async function uploadFile(inp) {
  if (!inp.files.length) return;
  showLoader(true, `Uploading ${inp.files.length} file(s)‚Ä¶`);
  for (const file of inp.files) await sb.storage.from('files').upload(`${currentPath==='/'?'':currentPath+'/'}${file.name}`, file, { upsert: true });
  showLoader(false); loadFiles(); showToast(`${inp.files.length} file(s) uploaded ‚úì`, 'success');
}
async function deleteFile(n) {
  if (!confirm(`Delete "${n}"?`)) return;
  await sb.storage.from('files').remove([`${currentPath==='/'?'':currentPath+'/'}${n}`]);
  loadFiles(); showToast('Deleted');
}
function downloadFile(n) {
  const { data } = sb.storage.from('files').getPublicUrl(`${currentPath==='/'?'':currentPath+'/'}${n}`);
  window.open(data.publicUrl, '_blank');
}

// ‚îÄ‚îÄ NOTES ‚îÄ‚îÄ
// ‚úÖ FIX: Gracefully handle missing columns (updated_at, tags, pinned)
async function loadNotes() {
  try {
    const { data, error } = await sb.from('notes').select('*').order('created_at', { ascending: false });
    if (error) {
      document.getElementById('notes-list').innerHTML = `<div style="padding:1rem;font-size:0.75rem;color:var(--red)">
        Error: ${error.message}<br><br>
        <span style="color:var(--soft)">Run in Supabase ‚Üí SQL Editor to fix:<br>
        <code style="color:var(--accent)">ALTER TABLE notes ADD COLUMN IF NOT EXISTS updated_at timestamptz DEFAULT now();</code>
        </span></div>`;
      return;
    }
    allNotes = data || [];
    document.getElementById('notes-count').textContent = allNotes.length;
    renderNotesList(allNotes);
  } catch(e) { console.error(e); }
}
function renderNotesList(notes) {
  const sorted = [...notes].sort((a,b) => {
    const ap = pinnedNotes.has(a.id) ? 1 : 0, bp = pinnedNotes.has(b.id) ? 1 : 0;
    return bp - ap;
  });
  document.getElementById('notes-list').innerHTML = sorted.map(n => {
    const isPinned = pinnedNotes.has(n.id);
    const preview = (n.content||'').replace(/[#*`>~-]/g,'').trim().slice(0,70);
    const d = new Date(n.updated_at || n.created_at);
    const ds = d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    return `<div class="note-item ${activeNoteId===n.id?'active':''}" onclick="openNote('${n.id}')" oncontextmenu="noteCtx(event,'${n.id}')">
      <div class="note-item-title">${isPinned?'üìå ':''}${n.title||'Untitled'}</div>
      <div class="note-item-preview">${preview||'Empty note'}</div>
      <div class="note-item-meta">${ds}</div>
    </div>`;
  }).join('') || '<div style="padding:2rem;text-align:center;font-size:0.8rem;color:var(--muted)">No notes yet<br><small>Press + to create one</small></div>';
}
function filterNotes(q) {
  if (!q.trim()) { renderNotesList(allNotes); return; }
  renderNotesList(allNotes.filter(n=>(n.title||'').toLowerCase().includes(q.toLowerCase())||(n.content||'').toLowerCase().includes(q.toLowerCase())));
}

async function createNewNote() {
  // ‚úÖ FIX: Try with updated_at first, fall back without it if column missing
  let payload = { title: 'Untitled Note', content: '' };
  try { payload.updated_at = new Date().toISOString(); } catch(e) {}
  let { data, error } = await sb.from('notes').insert([payload]).select();
  if (error && error.message.includes('updated_at')) {
    ({ data, error } = await sb.from('notes').insert([{ title: 'Untitled Note', content: '' }]).select());
  }
  if (error) { showToast('Create failed: ' + error.message, 'error'); return; }
  allNotes.unshift(data[0]);
  document.getElementById('notes-count').textContent = allNotes.length;
  renderNotesList(allNotes);
  openNote(data[0].id);
}

function openNote(id) {
  activeNoteId = id;
  const note = allNotes.find(n => n.id === id);
  if (!note) return;
  document.getElementById('editor-empty').style.display = 'none';
  document.getElementById('editor-main').classList.add('visible');
  document.getElementById('note-title').value = note.title || '';
  document.getElementById('note-content').value = note.content || '';
  document.getElementById('pin-btn').innerHTML = pinnedNotes.has(id) ? '<i class="ri-pushpin-fill"></i>' : '<i class="ri-pushpin-line"></i>';
  updateCounts();
  renderNotesList(allNotes);
  const d = new Date(note.updated_at || note.created_at);
  document.getElementById('last-saved').textContent = 'Saved ' + d.toLocaleTimeString();
}

function updateCounts() {
  const txt = document.getElementById('note-content').value;
  document.getElementById('word-count').textContent = (txt.trim() ? txt.trim().split(/\s+/).length : 0) + ' words';
  document.getElementById('char-count').textContent = txt.length + ' chars';
  document.getElementById('line-count').textContent = txt.split('\n').length + ' lines';
}

async function autoSave() {
  if (!activeNoteId) return;
  document.getElementById('save-status').textContent = '¬∑';
  if (saveTimeout) clearTimeout(saveTimeout);
  saveTimeout = setTimeout(async () => {
    const title   = document.getElementById('note-title').value;
    const content = document.getElementById('note-content').value;
    // ‚úÖ FIX: Try with updated_at, silently retry without if column missing
    let payload = { title, content };
    try { payload.updated_at = new Date().toISOString(); } catch(e) {}
    let { error } = await sb.from('notes').update(payload).eq('id', activeNoteId);
    if (error && error.message.includes('updated_at')) {
      ({ error } = await sb.from('notes').update({ title, content }).eq('id', activeNoteId));
    }
    document.getElementById('save-status').textContent = error ? '‚úó' : 'Saved';
    document.getElementById('last-saved').textContent = 'Saved ' + new Date().toLocaleTimeString();
    const note = allNotes.find(n => n.id === activeNoteId);
    if (note) { note.title = title; note.content = content; note.updated_at = new Date().toISOString(); }
    renderNotesList(allNotes);
  }, 1000);
}

async function deleteCurrentNote() {
  if (!activeNoteId || !confirm('Delete this note?')) return;
  await sb.from('notes').delete().eq('id', activeNoteId);
  allNotes = allNotes.filter(n => n.id !== activeNoteId);
  activeNoteId = null;
  document.getElementById('editor-main').classList.remove('visible');
  document.getElementById('editor-empty').style.display = 'flex';
  document.getElementById('notes-count').textContent = allNotes.length;
  renderNotesList(allNotes);
  showToast('Note deleted');
}

function togglePin() {
  if (!activeNoteId) return;
  pinnedNotes.has(activeNoteId) ? pinnedNotes.delete(activeNoteId) : pinnedNotes.add(activeNoteId);
  localStorage.setItem('vx_pins', JSON.stringify([...pinnedNotes]));
  document.getElementById('pin-btn').innerHTML = pinnedNotes.has(activeNoteId) ? '<i class="ri-pushpin-fill"></i>' : '<i class="ri-pushpin-line"></i>';
  renderNotesList(allNotes);
  showToast(pinnedNotes.has(activeNoteId) ? 'Pinned üìå' : 'Unpinned', 'success');
}

function exportNote() {
  const title = document.getElementById('note-title').value || 'note';
  const blob = new Blob([`# ${title}\n\n${document.getElementById('note-content').value}`], { type: 'text/markdown' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${title}.md`; a.click();
  showToast('Exported as .md ‚úì', 'success');
}

function copyNoteContent() {
  navigator.clipboard.writeText(document.getElementById('note-content').value);
  showToast('Copied ‚úì', 'success');
}

// ‚îÄ‚îÄ TOOLBAR ‚îÄ‚îÄ
function insertMd(before, after) {
  const ta = document.getElementById('note-content');
  const s = ta.selectionStart, e = ta.selectionEnd, sel = ta.value.slice(s,e);
  ta.value = ta.value.slice(0,s) + before + sel + after + ta.value.slice(e);
  ta.selectionStart = s + before.length; ta.selectionEnd = e + before.length;
  ta.focus(); autoSave();
}
function insertPrefix(p) {
  const ta = document.getElementById('note-content');
  const s = ta.selectionStart;
  const ls = ta.value.lastIndexOf('\n', s-1) + 1;
  ta.value = ta.value.slice(0,ls) + p + ta.value.slice(ls);
  ta.selectionStart = ta.selectionEnd = s + p.length;
  ta.focus(); autoSave();
}

// ‚îÄ‚îÄ AI ‚îÄ‚îÄ
function openHumanizer() { document.getElementById('humanizer-input').value=''; document.getElementById('humanizer-result').style.display='none'; document.getElementById('humanizer-modal').classList.remove('hidden'); }
function humanizeNote() { document.getElementById('humanizer-input').value = document.getElementById('note-content').value; document.getElementById('humanizer-result').style.display='none'; document.getElementById('humanizer-modal').classList.remove('hidden'); }
async function runHumanizer() {
  const text = document.getElementById('humanizer-input').value.trim();
  if (!text) { showToast('Enter some text first', 'error'); return; }
  showLoader(true, 'Humanizing‚Ä¶');
  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ model:'claude-sonnet-4-5-20250929', max_tokens:2048, messages:[{ role:'user', content:`Rewrite this to sound completely natural and human-written. Vary sentence lengths, use contractions naturally, avoid robotic phrasing. Preserve all meaning. Return ONLY the rewritten text:\n\n${text}` }] })
    });
    const d = await res.json();
    const out = d?.content?.[0]?.text;
    if (out) { document.getElementById('humanizer-output').textContent = out; document.getElementById('humanizer-result').style.display='block'; }
    else showToast('AI error', 'error');
  } catch(e) { showToast('Error: ' + e.message, 'error'); }
  showLoader(false);
}
function insertHumanizerToNote() {
  document.getElementById('note-content').value = document.getElementById('humanizer-output').textContent;
  autoSave(); closeModal('humanizer-modal'); showToast('Inserted into note ‚úì', 'success');
}
function openSummarizer() { document.getElementById('summarizer-input').value=''; document.getElementById('summarizer-result').style.display='none'; document.getElementById('summarizer-modal').classList.remove('hidden'); }
function summarizeNote() { document.getElementById('summarizer-input').value = document.getElementById('note-content').value; document.getElementById('summarizer-result').style.display='none'; document.getElementById('summarizer-modal').classList.remove('hidden'); }
async function runSummarizer() {
  const text = document.getElementById('summarizer-input').value.trim();
  if (!text) { showToast('Enter some text first', 'error'); return; }
  showLoader(true, 'Summarizing‚Ä¶');
  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ model:'claude-sonnet-4-5-20250929', max_tokens:1024, messages:[{ role:'user', content:`Write a clear bullet-point summary capturing all key points. Return ONLY the summary:\n\n${text}` }] })
    });
    const d = await res.json();
    const out = d?.content?.[0]?.text;
    if (out) { document.getElementById('summarizer-output').textContent = out; document.getElementById('summarizer-result').style.display='block'; }
    else showToast('AI error', 'error');
  } catch(e) { showToast('Error: ' + e.message, 'error'); }
  showLoader(false);
}
function copyResult(id) { navigator.clipboard.writeText(document.getElementById(id).textContent); showToast('Copied ‚úì', 'success'); }

// ‚îÄ‚îÄ CONTEXT MENU ‚îÄ‚îÄ
let ctxId = null;
function noteCtx(e, id) {
  e.preventDefault(); ctxId = id;
  const m = document.getElementById('ctx-menu');
  m.classList.remove('hidden');
  m.style.left = Math.min(e.clientX, window.innerWidth-160) + 'px';
  m.style.top  = Math.min(e.clientY, window.innerHeight-160) + 'px';
  document.getElementById('ctx-pin').innerHTML = `<i class="ri-pushpin-line"></i> ${pinnedNotes.has(id)?'Unpin':'Pin'}`;
}
document.getElementById('ctx-open').onclick = () => { if(ctxId){openNote(ctxId);} document.getElementById('ctx-menu').classList.add('hidden'); };
document.getElementById('ctx-pin').onclick = () => { if(ctxId){const prev=activeNoteId;activeNoteId=ctxId;togglePin();activeNoteId=prev;} document.getElementById('ctx-menu').classList.add('hidden'); };
document.getElementById('ctx-export').onclick = () => { if(ctxId){const n=allNotes.find(x=>x.id===ctxId);if(n){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([`# ${n.title}\n\n${n.content}`],{type:'text/markdown'}));a.download=`${n.title||'note'}.md`;a.click();showToast('Exported ‚úì','success');}} document.getElementById('ctx-menu').classList.add('hidden'); };
document.getElementById('ctx-delete').onclick = () => { if(ctxId){activeNoteId=ctxId;deleteCurrentNote();} document.getElementById('ctx-menu').classList.add('hidden'); };
document.addEventListener('click', () => document.getElementById('ctx-menu').classList.add('hidden'));
document.addEventListener('keydown', e => { if(e.key==='Escape'){document.getElementById('ctx-menu').classList.add('hidden');document.querySelectorAll('.modal-overlay').forEach(m=>m.classList.add('hidden'));}});
</script>
</body>
</html>
